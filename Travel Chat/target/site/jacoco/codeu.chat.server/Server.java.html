<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Server.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cloud-bigtable-hello-world</a> &gt; <a href="index.source.html" class="el_package">codeu.chat.server</a> &gt; <span class="el_source">Server.java</span></div><h1>Server.java</h1><pre class="source lang-java linenums">// Copyright 2017 Google Inc.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//    http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.


package codeu.chat.server;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.Arrays;
import java.util.Collection;

import codeu.chat.common.Conversation;
import codeu.chat.common.ConversationSummary;
import codeu.chat.common.Group;
import codeu.chat.common.GroupSummary;
import codeu.chat.common.LinearUuidGenerator;
import codeu.chat.common.Message;
import codeu.chat.common.NetworkCode;
import codeu.chat.common.Relay;
import codeu.chat.common.User;
import codeu.chat.util.Logger;
import codeu.chat.util.Serializers;
import codeu.chat.util.Time;
import codeu.chat.util.Timeline;
import codeu.chat.util.Uuid;
import codeu.chat.util.connections.Connection;

public final class Server {

<span class="nc" id="L44">  private static final Logger.Log LOG = Logger.newLog(Server.class);</span>

  private static final int RELAY_REFRESH_MS = 5000;  // 5 seconds

<span class="nc" id="L48">  private final Timeline timeline = new Timeline();</span>

  private final Uuid id;
  private final byte[] secret;

  private final Model model;
  private final View view;
  private final Controller controller;

  private final Relay relay;
<span class="nc" id="L58">  private Uuid lastSeen = Uuid.NULL;</span>

  public final String projectId;
  public final String instanceId;
  // public final String userTable;
  // public final String conversationTable;
  // public final String groupTable;
  // public final String messageTable;


  public Server(final Uuid id, 
                final byte[] secret, 
                final Relay relay, 
                final String projectId,
                final String instanceId,
<span class="nc" id="L73">                final String[] tableNames) {</span>

<span class="nc" id="L75">    this.id = id;</span>
<span class="nc" id="L76">    this.secret = Arrays.copyOf(secret, secret.length);</span>

<span class="nc" id="L78">    this.model = new Model(projectId, instanceId, tableNames);</span>
<span class="nc" id="L79">    this.view = new View(model);</span>
<span class="nc" id="L80">    this.controller = new Controller(id, model);</span>
<span class="nc" id="L81">    this.relay = relay;</span>

<span class="nc" id="L83">    this.projectId = projectId;</span>
<span class="nc" id="L84">    this.instanceId = instanceId;</span>

    // this.userTable = tableNames[0];
    // this.conversationTable = tableNames[1];
    // this.groupTable = tableNames[2];
    // this.messageTable = tableNames[3];

<span class="nc" id="L91">    timeline.scheduleNow(new Runnable() {</span>
      @Override
      public void run() {
        try {

<span class="nc" id="L96">          LOG.info(&quot;Reading update from relay...&quot;);</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">          for (final Relay.Bundle bundle : relay.read(id, secret, lastSeen, 32)) {</span>
<span class="nc" id="L99">            onBundle(bundle);</span>
<span class="nc" id="L100">            lastSeen = bundle.id();</span>
<span class="nc" id="L101">          }</span>

<span class="nc" id="L103">        } catch (Exception ex) {</span>

<span class="nc" id="L105">          LOG.error(ex, &quot;Failed to read update from relay.&quot;);</span>

<span class="nc" id="L107">        }</span>

<span class="nc" id="L109">        timeline.scheduleIn(RELAY_REFRESH_MS, this);</span>
<span class="nc" id="L110">      }</span>
    });
<span class="nc" id="L112">  }</span>

  public void handleConnection(final Connection connection) {
<span class="nc" id="L115">    timeline.scheduleNow(new Runnable() {</span>
      @Override
      public void run() {
        try {

<span class="nc" id="L120">          LOG.info(&quot;Handling connection...&quot;);</span>

<span class="nc" id="L122">          final boolean success = onMessage(</span>
<span class="nc" id="L123">              connection.in(),</span>
<span class="nc" id="L124">              connection.out());</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">          LOG.info(&quot;Connection handled: %s&quot;, success ? &quot;ACCEPTED&quot; : &quot;REJECTED&quot;);</span>
<span class="nc" id="L127">        } catch (Exception ex) {</span>

<span class="nc" id="L129">          LOG.error(ex, &quot;Exception while handling connection.&quot;);</span>

<span class="nc" id="L131">        }</span>

        try {
<span class="nc" id="L134">          connection.close();</span>
<span class="nc" id="L135">        } catch (Exception ex) {</span>
<span class="nc" id="L136">          LOG.error(ex, &quot;Exception while closing connection.&quot;);</span>
<span class="nc" id="L137">        }</span>
<span class="nc" id="L138">      }</span>
    });
<span class="nc" id="L140">  }</span>

  private boolean onMessage(InputStream in, OutputStream out) throws IOException {
<span class="nc" id="L143">    final int type = Serializers.INTEGER.read(in);</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (type == NetworkCode.NEW_MESSAGE_REQUEST) {</span>

<span class="nc" id="L147">      final Uuid author = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L148">      final Uuid conversation = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L149">      final Uuid group = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L150">      final String content = Serializers.STRING.read(in);</span>

<span class="nc" id="L152">      final Message message = controller.newMessage(author, conversation, group, content);</span>

<span class="nc" id="L154">      Serializers.INTEGER.write(out, NetworkCode.NEW_MESSAGE_RESPONSE);</span>
<span class="nc" id="L155">      Serializers.nullable(Message.SERIALIZER).write(out, message);</span>

<span class="nc" id="L157">      timeline.scheduleNow(createSendToRelayEvent(</span>
          author,
          conversation,
          group,
          message.id));

<span class="nc bnc" id="L163" title="All 2 branches missed.">    } else if (type == NetworkCode.NEW_USER_REQUEST) {</span>

<span class="nc" id="L165">      final String name = Serializers.STRING.read(in);</span>
<span class="nc" id="L166">      final String nickname = Serializers.STRING.read(in);</span>
<span class="nc" id="L167">      final String pass = Serializers.STRING.read(in);</span>

<span class="nc" id="L169">      final User user = controller.newUser(name, nickname, pass);</span>

<span class="nc" id="L171">      Serializers.INTEGER.write(out, NetworkCode.NEW_USER_RESPONSE);</span>

<span class="nc" id="L173">      Serializers.nullable(User.SERIALIZER).write(out, user);</span>

<span class="nc bnc" id="L175" title="All 2 branches missed.">    } else if (type == NetworkCode.NEW_NICKNAME_REQUEST) {</span>

<span class="nc" id="L177">      final Uuid uuid = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L178">      final String nickname = Serializers.STRING.read(in);</span>

<span class="nc" id="L180">      final User response = controller.setNickname(uuid, nickname);</span>

<span class="nc" id="L182">      Serializers.INTEGER.write(out, NetworkCode.NEW_NICKNAME_RESPONSE);</span>
<span class="nc" id="L183">      Serializers.nullable(User.SERIALIZER).write(out, response);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">    } else if (type == NetworkCode.REMOVE_USER_REQUEST) {</span>

      //final Uuid id = Uuid.SERIALIZER.read(in);
<span class="nc" id="L187">      final String name = Serializers.STRING.read(in);</span>

<span class="nc" id="L189">      final User user = controller.deleteUser(name);</span>

<span class="nc" id="L191">      Serializers.INTEGER.write(out, NetworkCode.REMOVE_USER_RESPONSE);</span>
<span class="nc" id="L192">      Serializers.nullable(User.SERIALIZER).write(out, user);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">    } else if (type == NetworkCode.NEW_CONVERSATION_REQUEST) {</span>
<span class="nc" id="L194">      LOG.info(&quot;servernewConversation1&quot;);</span>

<span class="nc" id="L196">      final String title = Serializers.STRING.read(in);</span>
<span class="nc" id="L197">      final Uuid owner = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L198">      final Uuid group = Uuid.SERIALIZER.read(in);</span>

<span class="nc" id="L200">      LOG.info(&quot;servernewConversation2donereading&quot;+title+owner+group);</span>

<span class="nc" id="L202">      final Conversation conversation = controller.newConversation(title, owner, group);</span>

<span class="nc" id="L204">      Serializers.INTEGER.write(out, NetworkCode.NEW_CONVERSATION_RESPONSE);</span>
<span class="nc" id="L205">      Serializers.nullable(Conversation.SERIALIZER).write(out, conversation);</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">    } else if (type == NetworkCode.DELETE_CONVERSATION_REQUEST) {</span>

<span class="nc" id="L209">      final String title = Serializers.STRING.read(in);</span>

<span class="nc" id="L211">      final Conversation conversation = controller.deleteConversation(title);</span>

<span class="nc" id="L213">      Serializers.INTEGER.write(out, NetworkCode.DELETE_CONVERSATION_RESPONSE);</span>
<span class="nc" id="L214">      Serializers.nullable(Conversation.SERIALIZER).write(out, conversation);</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">    } else if (type == NetworkCode.NEW_GROUP_REQUEST) {</span>

<span class="nc" id="L218">      final String title = Serializers.STRING.read(in);</span>
<span class="nc" id="L219">      final Uuid owner = Uuid.SERIALIZER.read(in);</span>

<span class="nc" id="L221">      final Group group = controller.newGroup(title, owner);</span>

<span class="nc" id="L223">      Serializers.INTEGER.write(out, NetworkCode.NEW_GROUP_RESPONSE);</span>
<span class="nc" id="L224">      Serializers.nullable(Group.SERIALIZER).write(out, group);</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_USERS_BY_ID_REQUEST) {</span>

<span class="nc" id="L228">      final Collection&lt;Uuid&gt; ids = Serializers.collection(Uuid.SERIALIZER).read(in);</span>

<span class="nc" id="L230">      final Collection&lt;User&gt; users = view.getUsers(ids);</span>

<span class="nc" id="L232">      Serializers.INTEGER.write(out, NetworkCode.GET_USERS_BY_ID_RESPONSE);</span>
<span class="nc" id="L233">      Serializers.collection(User.SERIALIZER).write(out, users);</span>

<span class="nc bnc" id="L235" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_ALL_CONVERSATIONS_REQUEST) {</span>

<span class="nc" id="L237">      final Collection&lt;ConversationSummary&gt; conversations = view.getAllConversations();</span>

<span class="nc" id="L239">      Serializers.INTEGER.write(out, NetworkCode.GET_ALL_CONVERSATIONS_RESPONSE);</span>
<span class="nc" id="L240">      Serializers.collection(ConversationSummary.SERIALIZER).write(out, conversations);</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_CONVERSATIONS_BY_ID_REQUEST) {</span>

<span class="nc" id="L244">      final Collection&lt;Uuid&gt; ids = Serializers.collection(Uuid.SERIALIZER).read(in);</span>

<span class="nc" id="L246">      final Collection&lt;Conversation&gt; conversations = view.getConversations(ids);</span>

<span class="nc" id="L248">      Serializers.INTEGER.write(out, NetworkCode.GET_CONVERSATIONS_BY_ID_RESPONSE);</span>
<span class="nc" id="L249">      Serializers.collection(Conversation.SERIALIZER).write(out, conversations);</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_ALL_GROUPS_REQUEST) {</span>

<span class="nc" id="L253">      final Collection&lt;GroupSummary&gt; groups = view.getAllGroups();</span>

<span class="nc" id="L255">      Serializers.INTEGER.write(out, NetworkCode.GET_ALL_GROUPS_RESPONSE);</span>
<span class="nc" id="L256">      Serializers.collection(GroupSummary.SERIALIZER).write(out, groups);</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_GROUPS_BY_ID_REQUEST) {</span>

<span class="nc" id="L260">      final Collection&lt;Uuid&gt; ids = Serializers.collection(Uuid.SERIALIZER).read(in);</span>

<span class="nc" id="L262">      final Collection&lt;Group&gt; groups = view.getGroups(ids);</span>

<span class="nc" id="L264">      Serializers.INTEGER.write(out, NetworkCode.GET_GROUPS_BY_ID_RESPONSE);</span>
<span class="nc" id="L265">      Serializers.collection(Group.SERIALIZER).write(out, groups);</span>

<span class="nc bnc" id="L267" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_MESSAGES_BY_ID_REQUEST) {</span>

<span class="nc" id="L269">      final Collection&lt;Uuid&gt; ids = Serializers.collection(Uuid.SERIALIZER).read(in);</span>

<span class="nc" id="L271">      final Collection&lt;Message&gt; messages = view.getMessages(ids);</span>

<span class="nc" id="L273">      Serializers.INTEGER.write(out, NetworkCode.GET_MESSAGES_BY_ID_RESPONSE);</span>
<span class="nc" id="L274">      Serializers.collection(Message.SERIALIZER).write(out, messages);</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_USER_GENERATION_REQUEST) {</span>

<span class="nc" id="L278">      Serializers.INTEGER.write(out, NetworkCode.GET_USER_GENERATION_RESPONSE);</span>
<span class="nc" id="L279">      Uuid.SERIALIZER.write(out, view.getUserGeneration());</span>

<span class="nc bnc" id="L281" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_USERS_EXCLUDING_REQUEST) {</span>

<span class="nc" id="L283">      final Collection&lt;Uuid&gt; ids = Serializers.collection(Uuid.SERIALIZER).read(in);</span>

<span class="nc" id="L285">      final Collection&lt;User&gt; users = view.getUsersExcluding(ids);</span>

<span class="nc" id="L287">      Serializers.INTEGER.write(out, NetworkCode.GET_USERS_EXCLUDING_RESPONSE);</span>
<span class="nc" id="L288">      Serializers.collection(User.SERIALIZER).write(out, users);</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_CONVERSATIONS_BY_TIME_REQUEST) {</span>

<span class="nc" id="L292">      final Time startTime = Time.SERIALIZER.read(in);</span>
<span class="nc" id="L293">      final Time endTime = Time.SERIALIZER.read(in);</span>

<span class="nc" id="L295">      final Collection&lt;Conversation&gt; conversations = view.getConversations(startTime, endTime);</span>

<span class="nc" id="L297">      Serializers.INTEGER.write(out, NetworkCode.GET_CONVERSATIONS_BY_TIME_RESPONSE);</span>
<span class="nc" id="L298">      Serializers.collection(Conversation.SERIALIZER).write(out, conversations);</span>

<span class="nc bnc" id="L300" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_CONVERSATIONS_BY_TITLE_REQUEST) {</span>

<span class="nc" id="L302">      final String filter = Serializers.STRING.read(in);</span>

<span class="nc" id="L304">      final Collection&lt;Conversation&gt; conversations = view.getConversations(filter);</span>

<span class="nc" id="L306">      Serializers.INTEGER.write(out, NetworkCode.GET_CONVERSATIONS_BY_TITLE_RESPONSE);</span>
<span class="nc" id="L307">      Serializers.collection(Conversation.SERIALIZER).write(out, conversations);</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_GROUPS_BY_TIME_REQUEST) {</span>

<span class="nc" id="L311">      final Time startTime = Time.SERIALIZER.read(in);</span>
<span class="nc" id="L312">      final Time endTime = Time.SERIALIZER.read(in);</span>

<span class="nc" id="L314">      final Collection&lt;Group&gt; groups = view.getGroups(startTime, endTime);</span>

<span class="nc" id="L316">      Serializers.INTEGER.write(out, NetworkCode.GET_GROUPS_BY_TIME_RESPONSE);</span>
<span class="nc" id="L317">      Serializers.collection(Group.SERIALIZER).write(out, groups);</span>

<span class="nc bnc" id="L319" title="All 2 branches missed.">  } else if (type == NetworkCode.GET_GROUPS_BY_TITLE_REQUEST) {</span>

<span class="nc" id="L321">      final String filter = Serializers.STRING.read(in);</span>

<span class="nc" id="L323">      final Collection&lt;Group&gt; groups = view.getGroups(filter);</span>

<span class="nc" id="L325">      Serializers.INTEGER.write(out, NetworkCode.GET_GROUPS_BY_TITLE_RESPONSE);</span>
<span class="nc" id="L326">      Serializers.collection(Group.SERIALIZER).write(out, groups);</span>

<span class="nc bnc" id="L328" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_MESSAGES_BY_TIME_REQUEST) {</span>

<span class="nc" id="L330">      final Uuid conversation = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L331">      final Time startTime = Time.SERIALIZER.read(in);</span>
<span class="nc" id="L332">      final Time endTime = Time.SERIALIZER.read(in);</span>

<span class="nc" id="L334">      final Collection&lt;Message&gt; messages = view.getMessages(conversation, startTime, endTime);</span>

<span class="nc" id="L336">      Serializers.INTEGER.write(out, NetworkCode.GET_MESSAGES_BY_TIME_RESPONSE);</span>
<span class="nc" id="L337">      Serializers.collection(Message.SERIALIZER).write(out, messages);</span>

<span class="nc bnc" id="L339" title="All 2 branches missed.">    } else if (type == NetworkCode.GET_MESSAGES_BY_RANGE_REQUEST) {</span>

<span class="nc" id="L341">      final Uuid rootMessage = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L342">      final int range = Serializers.INTEGER.read(in);</span>

<span class="nc" id="L344">      final Collection&lt;Message&gt; messages = view.getMessages(rootMessage, range);</span>

<span class="nc" id="L346">      Serializers.INTEGER.write(out, NetworkCode.GET_MESSAGES_BY_RANGE_RESPONSE);</span>
<span class="nc" id="L347">      Serializers.collection(Message.SERIALIZER).write(out, messages);</span>

<span class="nc bnc" id="L349" title="All 2 branches missed.">    } else if (type == NetworkCode.CHECK_PASSWORD_REQUEST) {</span>

<span class="nc" id="L351">      final Uuid uuid = Uuid.SERIALIZER.read(in);</span>
<span class="nc" id="L352">      final String pass = Serializers.STRING.read(in);</span>

<span class="nc" id="L354">      final User response = controller.ifCorrectPassword(uuid, pass);</span>

<span class="nc" id="L356">      Serializers.INTEGER.write(out, NetworkCode.CHECK_PASSWORD_RESPONSE);</span>
<span class="nc" id="L357">      Serializers.nullable(User.SERIALIZER).write(out, response);</span>

<span class="nc" id="L359">    } else {</span>

      // In the case that the message was not handled make a dummy message with
      // the type &quot;NO_MESSAGE&quot; so that the client still gets something.

<span class="nc" id="L364">      Serializers.INTEGER.write(out, NetworkCode.NO_MESSAGE);</span>

    }

<span class="nc" id="L368">    return true;</span>
  }

  private void onBundle(Relay.Bundle bundle) {

<span class="nc" id="L373">    final Relay.Bundle.Component relayUser = bundle.user();</span>
<span class="nc" id="L374">    final Relay.Bundle.Component relayConversation = bundle.conversation();</span>
<span class="nc" id="L375">    final Relay.Bundle.Component relayGroup = bundle.group();</span>
<span class="nc" id="L376">    final Relay.Bundle.Component relayMessage = bundle.user();</span>

<span class="nc" id="L378">    User user = model.userById().first(relayUser.id());</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">    if (user == null) {</span>
<span class="nc" id="L381">      user = controller.newUser(relayUser.id(), relayUser.text(), relayUser.time());</span>
    }

<span class="nc" id="L384">    Group group = model.groupById().first(relayGroup.id());</span>

<span class="nc bnc" id="L386" title="All 2 branches missed.">    if (group == null) {</span>
<span class="nc" id="L387">      group = controller.newGroup(relayGroup.id(), relayGroup.text(), user.id, relayGroup.time());</span>
    }

<span class="nc" id="L390">    Conversation conversation = model.conversationById().first(relayConversation.id());</span>

<span class="nc bnc" id="L392" title="All 2 branches missed.">    if (conversation == null) {</span>

      // As the relay does not tell us who made the conversation - the first person who
      // has a message in the conversation will get ownership over this server's copy
      // of the conversation.
<span class="nc" id="L397">      conversation = controller.newConversation(relayConversation.id(),</span>
<span class="nc" id="L398">                                                relayConversation.text(),</span>
                                                user.id,
                                                group.id,
<span class="nc" id="L401">                                                relayConversation.time());</span>
    }

<span class="nc" id="L404">    Message message = model.messageById().first(relayMessage.id());</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">    if (message == null) {</span>
<span class="nc" id="L407">      message = controller.newMessage(relayMessage.id(),</span>
                                      user.id,
                                      conversation.id,
                                      group.id,
<span class="nc" id="L411">                                      relayMessage.text(),</span>
<span class="nc" id="L412">                                      relayMessage.time());</span>
    }
<span class="nc" id="L414">  }</span>

  private Runnable createSendToRelayEvent(final Uuid userId,
                                          final Uuid conversationId,
                                          final Uuid groupId,
                                          final Uuid messageId) {
<span class="nc" id="L420">    return new Runnable() {</span>
      @Override
      public void run() {
<span class="nc" id="L423">        final User user = view.findUser(userId);</span>
<span class="nc" id="L424">        final Conversation conversation = view.findConversation(conversationId);</span>
<span class="nc" id="L425">        final Group group = view.findGroup(groupId);</span>
<span class="nc" id="L426">        final Message message = view.findMessage(messageId);</span>
<span class="nc" id="L427">        relay.write(id,</span>
<span class="nc" id="L428">                    secret,</span>
<span class="nc" id="L429">                    relay.pack(user.id, user.name, user.creation),</span>
<span class="nc" id="L430">                    relay.pack(conversation.id, conversation.title, conversation.creation),</span>
<span class="nc" id="L431">                    relay.pack(group.id, group.title, group.creation),</span>
<span class="nc" id="L432">                    relay.pack(message.id, message.content, message.creation));</span>
<span class="nc" id="L433">      }</span>
    };
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>